<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root { --bg-app: #f8fafc;
        --bg-panel: #ffffff; --text-main: #0f172a; --text-sub: #64748b; --accent: #3b82f6; --accent-hover: #2563eb; --border: #cbd5e1; --input-bg: #ffffff; --success: #10b981; --danger: #ef4444; --danger-hover: #dc2626;
        --card-kpi-bg: #ffffff; }
      [data-theme="dark"] { --bg-app: #0f172a; --bg-panel: #1e293b; --text-main: #f8fafc; --text-sub: #94a3b8; --accent: #60a5fa;
        --accent-hover: #3b82f6; --border: #475569; --input-bg: #0f172a; --card-kpi-bg: #1e293b; }
      
      body { margin: 0;
        padding: 20px; font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-main); transition: 0.3s; height: 100vh; box-sizing: border-box; overflow: hidden;
      }
      .app-wrapper { display: flex; flex-direction: column; height: 100%; gap: 15px; max-width: 1400px;
        margin: 0 auto; width: 100%; }
      
      .header { display: flex;
        justify-content: space-between; align-items: center; }
      .title { margin: 0; font-size: 22px; font-weight: 800;
      }
      .nav { display: flex; gap: 8px; flex-wrap: wrap;
      }
      .nav-btn { padding: 10px 18px; border: 1px solid var(--border); background: var(--bg-panel); color: var(--text-sub);
        border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; white-space: nowrap; }
      .nav-btn.active { background: var(--accent);
        color: white; border-color: var(--accent); }
      .content-area { flex: 1; position: relative; overflow: hidden; background-color: var(--bg-panel);
        border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.05); z-index: 10;
      }
      .tab-page { display: none; height: 100%; overflow-y: auto; padding: 30px; box-sizing: border-box; -webkit-overflow-scrolling: touch;
      }
      .tab-page.active { display: block; }

      label { font-size: 11px;
        font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin-bottom: 5px; display: block;
      }
      input, select { width: 100%; padding: 12px 15px; border-radius: 10px; border: 2px solid var(--border);
        background-color: var(--input-bg); color: var(--text-main); font-family: 'Inter'; font-size: 14px; outline: none; box-sizing: border-box;
      }
      input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      }
      input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0;
      }
      input[type="number"] { -moz-appearance: textfield;
      }
      
      .btn { width: 100%; padding: 12px; background: var(--accent);
        color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.2s;
      }
      .btn:hover { background: var(--accent-hover); }
      .btn:disabled { opacity: 0.6;
        cursor: not-allowed; }
      .btn-sm { width: auto; padding: 8px 16px; font-size: 13px; border-radius: 8px;
      }

      .btn-action { padding: 8px 14px; font-size: 13px; font-weight: 600; border-radius: 8px; border: none;
        cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; white-space: nowrap; min-width: 80px;
      }
      .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid transparent;
      }
      .btn-danger:hover { background: var(--danger); color: white;
      }
      .btn-save { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid transparent;
      }
      .btn-save:hover { background: var(--success); color: white;
      }

      .responsive-table-wrapper { border: 1px solid var(--border); border-radius: 10px; overflow-x: auto; background: var(--bg-panel);
      }
      table { width: 100%; border-collapse: collapse; font-size: 13px;
      }
      th { text-align: left; padding: 15px; color: var(--text-sub); border-bottom: 1px solid var(--border); background: var(--input-bg);
        font-weight: 700; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }
      td { padding: 12px 15px;
        border-bottom: 1px solid var(--border); vertical-align: middle; }
      
      .w-check { width: 40px;
        text-align: center; }
      .w-check input { width: 20px; height: 20px; cursor: pointer; accent-color: var(--accent);
        vertical-align: middle; }
      
      .tbl-input { width: 100%;
        border: 1px solid transparent; background: transparent; font-weight: 500; padding: 8px; border-radius: 6px; transition: 0.2s; font-size:13px;
      }
      .tbl-input:focus, .tbl-input:hover { border-color: var(--border); background: var(--input-bg);
      }

      .table-box { background: var(--bg-panel); border-radius: 12px; border: 1px solid var(--border); height: 300px; display: flex;
        flex-direction: column; overflow: hidden; position: relative; }
      .table-box-header { padding: 15px; font-size: 14px; font-weight: 700;
        color: var(--text-sub); text-transform: uppercase; border-bottom: 1px solid var(--border); background: var(--input-bg); flex-shrink: 0;
      }
      .table-box-scroll { overflow-y: auto; flex: 1; padding: 0;
      }
      .analytics-table { width: 100%; border-collapse: collapse;
      }
      .analytics-table th { position: sticky; top: 0; background: var(--input-bg); z-index: 5;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05); padding: 12px 15px; font-size: 11px; color: var(--text-sub);
      }
      .analytics-table td { padding: 10px 15px; border-bottom: 1px solid var(--border); font-size: 13px;
      }
      .analytics-table tr:last-child td { border-bottom: none;
      }

      .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;
      }
      .card { background: var(--card-kpi-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border);
        box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; flex-direction: column; justify-content: space-between;
      }
      .card-val { font-size: 24px; font-weight: 800; margin-top: 5px; color: var(--accent);
      }
      .card-lbl { font-size: 11px; font-weight: 700; color: var(--text-sub); text-transform: uppercase;
      }
      .trend-badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700;
        margin-top: 8px; width: fit-content; }
      .trend-up { background: rgba(16, 185, 129, 0.15); color: var(--success);
      }
      .trend-down { background: rgba(239, 68, 68, 0.15); color: var(--danger);
      }
      .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;
      }
      .chart-box { background: var(--input-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border); height: 300px;
        position: relative; }
      
      .loader { position: fixed; top: 0;
        left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 999; display: none; backdrop-filter: blur(4px);
        flex-direction: column; color: white; font-weight: 600; }
      .spin { width: 30px; height: 30px;
        border: 3px solid #fff; border-top-color: var(--accent); border-radius: 50%; animation: r 1s infinite linear; margin-bottom: 10px;
      }
      @keyframes r { to { transform: rotate(360deg);
      } }

      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 4000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px);
      }
      .modal-box { background: var(--bg-panel); padding: 25px; border-radius: 16px; width: 90%; max-width: 350px; text-align: center;
        border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.2); transform: scale(0.9); transition: 0.2s;
      }
      .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 10px;
      }
      .modal-actions { display: flex; gap: 10px; margin-top: 20px;
      }
      .modal-actions button { flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer;
        border: none; font-size: 14px; }
      .btn-confirm-yes { background: var(--danger); color: white;
      }
      .btn-confirm-no { background: var(--input-bg); border: 1px solid var(--border) !important; color: var(--text-main);
      }

      .qty-wrapper { display: flex; align-items: center; justify-content: center; background-color: var(--input-bg); border: 2px solid var(--border);
        border-radius: 10px; overflow: hidden; height: 46px; }
      .qty-btn { width: 50px; height: 100%; background: transparent;
        border: none; color: var(--text-main); font-size: 20px; font-weight: 700; cursor: pointer; }
      .qty-input { width: 80px;
        text-align: center; border: none; background: transparent; font-weight: 700; font-size: 18px;
      }
      
      .toast { visibility: hidden; min-width: 250px; background-color: var(--text-main);
        color: var(--bg-app); text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px;
        font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transition: 0.3s;
      }
      .toast.show { visibility: visible; opacity: 1; bottom: 50px;
      }
      .toast.error { background-color: var(--danger); color: white;
      }
      .toast.success { background-color: var(--success); color: white;
      }
      .search-box { position: relative; }
      .results-list { position: absolute;
        top: 105%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: var(--bg-panel); border: 2px solid var(--accent); border-radius: 10px; z-index: 100;
        display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
      .res-item { padding: 12px 15px; cursor: pointer;
        border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
      .res-item:hover { background: var(--input-bg); color: var(--accent);
      }

      /* –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–¢–ö–ê: –°—Ç—Ä–æ–∫–∞ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ */
      .ship-row {
          display: flex; gap: 15px; align-items: center; width: 100%; flex-wrap: wrap;
      }
      .ship-row > div { flex: 1; }

      @media (max-width: 768px) {
        body { padding: 10px;
        height: auto; overflow: auto; }
        .app-wrapper { height: auto; min-height: 100vh;
        }
        .content-area, .tab-page { overflow: visible; height: auto; padding: 15px;
        }
        .nav { flex-wrap: nowrap; overflow-x: auto; padding-bottom: 5px;
        }
        .kpi-row { grid-template-columns: 1fr 1fr;
        }
        .charts-grid, .bottom-grid { grid-template-columns: 1fr;
        }
        
        .responsive-table-wrapper table, .responsive-table-wrapper thead, .responsive-table-wrapper tbody, .responsive-table-wrapper th, .responsive-table-wrapper td, .responsive-table-wrapper tr { display: block;
        }
        .responsive-table-wrapper thead tr { display: none;
        }
        .responsive-table-wrapper tr { margin-bottom: 15px; border: 1px solid var(--border); border-radius: 12px;
        background: var(--input-bg); padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .responsive-table-wrapper td { border: none;
        padding: 8px 0; position: relative; display: flex; align-items: center; justify-content: space-between;
        }
        .responsive-table-wrapper td::before { content: attr(data-label); font-weight: 700; font-size: 11px; color: var(--text-sub);
        text-transform: uppercase; margin-right: 15px; min-width: 80px; }
        .tbl-input { text-align: right;
        border: 1px solid var(--border); padding: 8px; }
        .responsive-table-wrapper td.actions-cell { justify-content: flex-end;
        border-top: 1px dashed var(--border); padding-top: 10px; margin-top: 5px; gap: 10px;
        }
        .responsive-table-wrapper td.actions-cell::before { display: none;
        }
        .w-check { width: 100%; text-align: left;
        }

        /* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ –≤ —Å—Ç–æ–ª–±–∏–∫ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ */
        .ship-row {
            flex-direction: column !important;
            align-items: stretch !important;
        }
        .ship-row > div {
            width: 100% !important;
            flex: none !important;
        }
        .ship-row button {
            width: 100% !important;
            margin-top: 5px;
        }
      }
      @media (max-width: 480px) { .kpi-row { grid-template-columns: 1fr;
      } }
    </style>
  </head>
  <body>
    <div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
    <div class="loader" id="loader"><div class="spin"></div><div id="loaderTxt">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
    
    <div id="confirmModal" class="modal-overlay">
       <div class="modal-box">
          <div style="font-size: 40px; margin-bottom: 10px;">üóëÔ∏è</div>
          <div class="modal-title">–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?</div>
          <div style="font-size: 13px; color: var(--text-sub);">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</div>
          <div class="modal-actions">
    
          <button class="btn-confirm-no" onclick="closeConfirm()">–ù–µ—Ç, –æ—Ç–º–µ–Ω–∞</button>
             <button class="btn-confirm-yes" id="btnConfirmYes">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
          </div>
       </div>
    </div>

    <div class="app-wrapper">
      <div class="header">
        <h1 class="title">CRM <span style="color:var(--accent)">–ú–µ–Ω–µ–¥–∂–µ—Ä</span></h1>
        
        <div id="robotContainer" onclick="toggleTheme()" style="width: 50px; height: 50px; background: #050505; border-radius: 14px; overflow: hidden; cursor: pointer; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.2); flex-shrink: 0; border: 1px solid var(--border);">
             <canvas id="robotCanvas" width="300" height="300" style="width: 100%; height: 100%; display: block;"></canvas>
        </div>

      </div>
      <div class="nav">
    
        <button class="nav-btn active" onclick="tab('Entry')">‚ûï –í–≤–æ–¥</button>
        <button class="nav-btn" onclick="tab('Unshipped')">üì¶ –û—Ç–≥—Ä—É–∑–∫–∞</button>
        <button class="nav-btn" onclick="tab('Ref')">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</button>
        <button class="nav-btn" onclick="tab('Analytics')">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
      </div>
      
      <div class="content-area">
        <div id="Entry" class="tab-page active">
           <div style="max-width: 500px;
        margin: 0 auto;">
             <h3>–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h3>
             <form id="formEntry">
               <div style="margin-bottom: 15px;"><label>–ì–æ—Ä–æ–¥ (–ú–∞–≥–∞–∑–∏–Ω)</label><select id="entryCity" required></select></div>
               <div class="search-box" style="margin-bottom: 15px;">
                 <label>–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞</label>
              
               <input type="text" id="searchInp" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å..." autocomplete="off" required>
                 <div class="results-list" id="resList"></div>
                 <input type="hidden" id="prodName">
               </div>
               <div style="display:grid;
        grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                 <div><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label><div class="qty-wrapper"><button type="button" class="qty-btn" onclick="changeQty(-1)">‚àí</button><input type="number" id="qty" value="1" min="1" class="qty-input" required><button type="button" class="qty-btn" onclick="changeQty(1)">+</button></div></div>
                 <div><label>–ò—Ç–æ–≥–æ</label><div id="totalPreview" style="padding: 12px;
        font-weight: 700; color: var(--accent); font-size:18px;">0 ‚ÇΩ</div></div>
               </div>
               <button type="submit" class="btn" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
             </form>
           </div>
        </div>

        <div id="Unshipped" class="tab-page">
           <div style="background: var(--input-bg);
        padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border);">
             <label style="font-size:13px;
        margin-bottom:10px;">–í–´–ë–ï–†–ò–¢–ï –ì–û–†–û–î –î–õ–Ø –û–¢–ì–†–£–ó–ö–ò:</label>
             
             <div class="ship-row">
               <div><select id="shipCity" onchange="loadUnshippedTable()"></select></div>
               <button class="btn btn-sm" onclick="loadUnshippedTable()">–û–±–Ω–æ–≤–∏—Ç—å</button>
             </div>

           </div>
           <div id="unshippedContent"><div style="text-align:center;
        color:var(--text-sub); margin-top: 50px;"><div style="font-size: 40px; margin-bottom:10px;">üè™</div>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤—ã—à–µ</div></div>
        </div>

        <div id="Ref" class="tab-page">
           <div style="display:flex;
        flex-direction:column; gap:25px;">
             <div style="background: var(--bg-panel); padding: 20px;
        border-radius: 12px; border: 1px solid var(--border);">
               <h4 style="margin-top:0">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h4>
               <form id="formRef" style="display:grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; align-items:end;">
                 <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="newPName" required></div>
                 <div><label>–¶–µ–Ω–∞</label><input type="number" id="newPPrice" required></div>
                 <div><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><input list="catList" id="newPCat" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ..." required><datalist id="catList"></datalist></div>
                 <button type="submit" class="btn" id="productSubmitBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
              
               </form>
             </div>
             <div>
                <input type="text" id="filterRef" placeholder="üîç –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫..." onkeyup="filterRef()" style="margin-bottom: 15px;">
                <div class="responsive-table-wrapper" style="max-height: 600px;
        overflow-y: auto;">
                    <table id="refTable">
                        <thead>
                            <tr>
                          
                        <th style="width:40%">–¢–æ–≤–∞—Ä</th>
                                <th style="width:25%">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                <th style="width:15%">–¶–µ–Ω–∞</th>
                           
                        <th style="text-align:right">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                  
                  </table>
                </div>
             </div>
           </div>
        </div>

        <div id="Analytics" class="tab-page">
           <div style="display:flex;
        gap:10px; margin-bottom: 20px; flex-wrap: wrap;">
             <select id="anYear" style="width:120px" onchange="loadAnalytics()"></select>
             <select id="anMonth" style="width:140px" onchange="loadAnalytics()"></select>
             <select id="anCity" style="flex: 1;
        min-width: 200px;" onchange="loadAnalytics()"><option value="All">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option></select>
             <button class="btn btn-sm" onclick="loadAnalytics()">–û–±–Ω–æ–≤–∏—Ç—å</button>
           </div>
           <div class="kpi-row" id="kpi"></div>
           <div class="charts-grid">
             <div class="chart-box">
                <div style="padding: 15px 15px 5px 15px;">
         
                    <div class="chart-title" style="margin:0">–î–∏–Ω–∞–º–∏–∫–∞ –í—ã—Ä—É—á–∫–∏</div>
                </div>
                <div style="height:240px;
        padding: 0 10px 10px 10px;"><canvas id="chartTrend"></canvas></div>
             </div>
             <div class="chart-box">
                <div style="padding: 15px 15px 5px 15px;">
                    <div class="chart-title" style="margin:0">–î–æ–ª—è –ì–æ—Ä–æ–¥–æ–≤</div>
                </div>
        
                <div style="height:240px; display:flex; justify-content:center;
        padding: 0 10px 10px 10px;"><canvas id="chartCity"></canvas></div>
             </div>
           </div>
           <div class="bottom-grid">
             <div class="chart-box">
                <div style="padding: 15px 15px 5px 15px;">
                    <div class="chart-title" style="margin:0">–ü—Ä–æ–¥–∞–∂–∏ –ø–æ 
        –ö–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
                </div>
                <div style="height:240px;
        padding: 0 10px 10px 10px;"><canvas id="chartCat"></canvas></div>
             </div>
             <div class="table-box">
                <div class="table-box-header">üèÜ –¢–æ–ø-20 –¢–æ–≤–∞—Ä–æ–≤</div>
                <div class="table-box-scroll">
                    <table id="topTable" class="analytics-table">
          
                        <thead>
                            <tr>
                                <th>–¢–æ–≤–∞—Ä</th>
                          
                        <th style="text-align:right">–°—É–º–º–∞</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                 
                   </table>
                </div>
             </div>
           </div>
        </div>
      </div>
    </div>

    <script>
      // ===============================================
      // üëá –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–°–´–õ–ö–£ –ü–û–°–õ–ï –î–ï–ü–õ–û–Ø (–®–ê–ì 2)
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbxlEkTvIEKr1giWms95LjD1dJXeoBeEgGdrZ20DNvvAEmx0ASn4IDuhbRuzp9x03WV2/exec';
      // ===============================================

      const IS_GOOGLE = typeof google !== 'undefined' && google.script && google.script.run;
      let CONFIG = {}, PRODUCTS = [], CHARTS = {}, LAST_DATA = null;
      let deleteCallback = null;
      window.onload = () => { 
        if(window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.expand();
        document.getElementById('loader').style.display='flex'; 
        
        loadConfig(); 
        
        document.getElementById('formEntry').onsubmit=saveEntry;
        document.getElementById('formRef').onsubmit=addRef; 
        document.getElementById('searchInp').oninput=smartSearch; 
        document.getElementById('qty').oninput=calcTotal; 
        if(localStorage.getItem('crm_theme')==='dark') {
            document.body.setAttribute('data-theme','dark');
            // –ö–Ω–æ–ø–∫–∞ —Ç–µ–º—ã —Ç–µ–ø–µ—Ä—å —Ä–æ–±–æ—Ç
        }
      };

      // --- –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ú–û–°–¢ ---
      async function runBackend(action, payload = {}) {
         if (IS_GOOGLE) {
             return new Promise((resolve, reject) => {
                 if(action === 'getInitialConfig') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getInitialConfig();
     
                 else if(action === 'saveNewEntry') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).saveNewEntry(payload);
                 else if(action === 'getUnshippedForCity') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getUnshippedForCity(payload.city);
                 else if(action === 'shipAndGeneratePdf') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).shipAndGeneratePdf(payload.city, payload.items);
                 else if(action === 'addNewProduct') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).addNewProduct(payload.name, payload.price, payload.cat);
                 else if(action === 'getAnalyticsData') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getAnalyticsData(payload.period, payload.mIdx, payload.yr, payload.city);
                 else if(action === 'updateOrderRow') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).updateLineItem(payload.city, payload.rowIndex, payload.name, payload.qty);
                 else if(action === 'deleteLineItem') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).deleteLineItem(payload.city, payload.rowIndex);
                 else if(action === 'updateProductRow') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).updateProductRow(payload.rowIndex, payload.name, payload.price, payload.cat);
                 else if(action === 'deleteProductRow') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).deleteProductRow(payload.rowIndex);
                 else reject("Unknown Func");
             });
         } else {
             if(GAS_URL.includes("–í–ê–®_")) {
                alert("–û–®–ò–ë–ö–ê: –í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –≤ –∫–æ–¥ Dashboard.html!");
                throw new Error("No URL");
             }
             payload.action = action;
             try {
                 const res = await fetch(GAS_URL, {
                     method: "POST",
                     headers: { "Content-Type": "text/plain;charset=utf-8" },
                     body: JSON.stringify(payload)
                 });
                 const text = await res.text();
                 try {
                    return JSON.parse(text);
                 } catch(e) {
                    console.error("Server HTML:", text);
                    if(text.includes("<!DOCTYPE")) throw new Error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞! –ü—Ä–æ–≤–µ—Ä—å Deploy: 'Anyone'");
                    throw new Error("Server Error: " + text);
                 }
             } catch(e) {
                 throw e;
             }
         }
      }

      function loadConfig(){
        runBackend('getInitialConfig')
        .then(c => {
          CONFIG=c; PRODUCTS=c.products; 
          fillSel('entryCity',c.cities); 
          const s=document.getElementById('shipCity');s.innerHTML='';s.add(new Option('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥...',''));c.cities.forEach(x=>s.add(new Option(x,x))); 
          fillSel('anCity',c.cities); 
          
          fillRefTable(c.directoryData); 

          const dl=document.getElementById('catList');dl.innerHTML='';
          c.categories.forEach(x=>{const o=document.createElement('option');o.value=x;dl.appendChild(o)}); 
          
          let prodList = document.getElementById('dlProducts');
          if(!prodList) { prodList = document.createElement('datalist'); prodList.id = 'dlProducts'; document.body.appendChild(prodList); }
          prodList.innerHTML = ''; c.products.forEach(p => { const op = document.createElement('option'); op.value = p.name; prodList.appendChild(op);
});

          const m=document.getElementById('anMonth'); m.innerHTML = ''; m.add(new Option('–í–µ—Å—å –≥–æ–¥', 'all')); 
          c.months.forEach((x,i)=>m.add(new Option(x,i))); m.value = new Date().getMonth(); 
          const ySel = document.getElementById('anYear');
          ySel.innerHTML = '';
          const currentY = new Date().getFullYear(); (c.years || [currentY]).forEach(y => ySel.add(new Option(y, y))); ySel.value = currentY;
          
          document.getElementById('loader').style.display='none'; 
          loadAnalytics();
        })
        .catch(err => { showToast("–û—à–∏–±–∫–∞ Config: " + err, true); document.getElementById('loader').style.display='none'; });
      }

      function loadUnshippedTable(){
        const c=document.getElementById('shipCity').value, d=document.getElementById('unshippedContent');
        if(!c)return;
        d.innerHTML='<div style="text-align:center; padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>'; 
        
        runBackend('getUnshippedForCity', {city: c})
        .then(i => {
            if(!i.length){d.innerHTML='<div style="text-align:center; padding:40px; opacity:0.7">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ! ‚úÖ</div>';return;}
            d.dataset.items = JSON.stringify(i);
            
            let h=`<div style="background:var(--input-bg); padding:15px; border-radius:10px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                  
                     <span>–í—Å–µ–≥–æ –ø–æ–∑.: <b>${i.length}</b></span>
                     <button class="btn btn-sm" style="background:var(--success)" onclick="doShip('${c}')">üìÑ –ù–∞–∫–ª–∞–¥–Ω–∞—è (PDF)</button>
                   </div>
            <div class="responsive-table-wrapper">
            <table>
              <thead>
          
                <tr>
                  <th class="w-check"><input type="checkbox" onchange="toggleAll(this)" checked></th>
                  <th style="width:80px">–î–∞—Ç–∞</th>
                  <th>–¢–æ–≤–∞—Ä</th>
                  <th style="width:70px">–ö–æ–ª-–≤–æ</th>
                
                  <th style="width:220px; text-align:right">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody>`;
            i.forEach((x, index)=>{ 
              h+=`<tr id="row-${index}">
                    <td class="w-check" data-label=""><input 
 type="checkbox" class="ship-chk" data-idx="${index}" checked></td>
                    <td data-label="–î–∞—Ç–∞" style="font-size:11px; color:var(--text-sub)">${x.date}</td>
                    <td data-label="–¢–æ–≤–∞—Ä"><input type="text" list="dlProducts" class="tbl-input" id="name-${index}" value="${x.name}" onchange="showSaveBtn(${index})"></td>
                    <td data-label="–ö–æ–ª-–≤–æ"><input type="number" class="tbl-input" id="qty-${index}" value="${x.qty}" min="1" style="width:80px" onchange="showSaveBtn(${index})"></td>
                   
                 <td data-label="–î–µ–π—Å—Ç–≤–∏—è" class="actions-cell">
                       <button id="btn-save-${index}" class="btn-action btn-save" onclick="saveRow('${c}', ${x.rowIndex}, ${index})" style="display:none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                       <button class="btn-action btn-danger" onclick="confirmDeleteRow('${c}', ${x.rowIndex})">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                  </tr>` 
 
            });
            h+='</tbody></table></div>';
            d.innerHTML=h;
        })
        .catch(err => d.innerHTML = "–û—à–∏–±–∫–∞: " + err);
      }

      function fillRefTable(d){
        const t = document.querySelector('#refTable tbody');
        t.innerHTML='';
        d.forEach((x, idx) => {
           const r = document.createElement('tr');
           r.id = `prod-row-${idx}`;
           r.innerHTML = `
             <td data-label="–¢–æ–≤–∞—Ä"><input type="text" class="tbl-input" id="p-name-${idx}" value="${x.name}" onchange="showProdSave(${idx})"></td>
             <td data-label="–ö–∞—Ç–µ–≥–æ—Ä–∏—è"><input type="text" list="catList" class="tbl-input" id="p-cat-${idx}" value="${x.category}" onchange="showProdSave(${idx})"></td>
             <td data-label="–¶–µ–Ω–∞"><input type="number" class="tbl-input" 
                id="p-price-${idx}" value="${x.price}" onchange="showProdSave(${idx})"></td>
             <td data-label="–î–µ–π—Å—Ç–≤–∏—è" class="actions-cell">
                <button id="btn-prod-save-${idx}" class="btn-action btn-save" onclick="saveProdRow(${x.rowIndex}, ${idx})" style="display:none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn-action btn-danger" onclick="confirmDeleteProdRow(${x.rowIndex})">–£–¥–∞–ª–∏—Ç—å</button>
             </td>
           `;
           t.appendChild(r);
        });
      }

      function showConfirm(callback) {
          deleteCallback = callback;
          document.getElementById('confirmModal').style.display = 'flex';
          document.getElementById('btnConfirmYes').onclick = () => {
              document.getElementById('confirmModal').style.display = 'none';
              if(deleteCallback) deleteCallback();
          };
      }
      function closeConfirm() {
          document.getElementById('confirmModal').style.display = 'none';
          deleteCallback = null;
      }

      function showSaveBtn(idx) { document.getElementById(`btn-save-${idx}`).style.display = 'inline-flex';
      }
      function saveRow(city, rowIndex, localIdx) {
         const btn = document.getElementById(`btn-save-${localIdx}`);
         btn.innerText = '‚è≥'; 
         runBackend('updateOrderRow', { city: city, rowIndex: rowIndex, name: document.getElementById(`name-${localIdx}`).value, qty: document.getElementById(`qty-${localIdx}`).value })
         .then(r => {
             if(r.success) { showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!", false); btn.style.display = 'none'; btn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; }
             else { showToast(r.message, true); btn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; }
         });
      }
      function confirmDeleteRow(city, rowIndex) {
         showConfirm(() => {
             document.getElementById('unshippedContent').innerHTML = '<div style="text-align:center; padding:20px;">–£–¥–∞–ª–µ–Ω–∏–µ...</div>';
             runBackend('deleteLineItem', { city: city, rowIndex: rowIndex }).then(r => { showToast(r.success?"–£–¥–∞–ª–µ–Ω–æ":r.message, !r.success); loadUnshippedTable(); });
         });
      }

      function showProdSave(idx) { document.getElementById(`btn-prod-save-${idx}`).style.display = 'inline-flex';
      }
      function saveProdRow(rowIndex, idx) {
         const btn = document.getElementById(`btn-prod-save-${idx}`);
         btn.innerText = '‚è≥';
         runBackend('updateProductRow', { rowIndex: rowIndex, name: document.getElementById(`p-name-${idx}`).value, price: document.getElementById(`p-price-${idx}`).value, cat: document.getElementById(`p-cat-${idx}`).value })
         .then(r => {
             if(r.success) { showToast("–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!", false); btn.style.display = 'none'; btn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; loadConfig(); }
             else { showToast(r.message, true); btn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; }
         });
      }
      function confirmDeleteProdRow(rowIndex) {
         showConfirm(() => {
             document.getElementById('loader').style.display='flex';
             runBackend('deleteProductRow', { rowIndex: rowIndex }).then(r => { showToast(r.success?"–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω":r.message, !r.success); loadConfig(); });
         });
      }

      function saveEntry(e){ e.preventDefault(); const b=document.getElementById('saveBtn'); const t=b.innerText; b.disabled=true; b.innerText='‚è≥...';
        runBackend('saveNewEntry', { city: document.getElementById('entryCity').value, productName: document.getElementById('searchInp').value, quantity: document.getElementById('qty').value })
        .then(r => { showToast(r.message, !r.success); b.disabled=false; b.innerText=t; if(r.success){ document.getElementById('searchInp').value=''; document.getElementById('qty').value=1; calcTotal(); }})
        .catch(err => { showToast("–û—à–∏–±–∫–∞: "+err, true); b.disabled=false; b.innerText=t; });
      }

      function doShip(c){
        const d=document.getElementById('unshippedContent'); if(!d.dataset.items) return;
        const checkboxes = document.querySelectorAll('.ship-chk:checked');
        if (checkboxes.length === 0) { showToast("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏–∏!", true); return;
        }
        const allItems=JSON.parse(d.dataset.items); const selectedItems = [];
        checkboxes.forEach(cb => selectedItems.push(allItems[parseInt(cb.getAttribute('data-idx'))]));
        
        const loader = document.getElementById('loader'), loaderTxt = document.getElementById('loaderTxt');
        loaderTxt.innerText = `–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF (${selectedItems.length} –ø–æ–∑.)...`; loader.style.display='flex';
        
        runBackend('shipAndGeneratePdf', { city: c, items: selectedItems }).then(r => {
            if(r.success){ 
                // --- –ü–†–û–í–ï–†–ö–ê –ú–û–ë–ò–õ–¨–ù–û–ì–û –£–°–¢–†–û–ô–°–¢–í–ê ---
                const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);

                if (!isMobile) {
                    window.open(window.URL.createObjectURL(base64ToBlob(r.pdfData)), '_blank');
                } else {
                    showToast("‚úÖ –û—Ç–≥—Ä—É–∂–µ–Ω–æ! (PDF —Å–æ–∑–¥–∞–Ω)", false);
                }
                loader.style.display='none'; loaderTxt.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞..."; loadUnshippedTable(); 
            }
            else { loader.style.display='none'; loaderTxt.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞..."; showToast(r.message, true); }
        }).catch(e => { loader.style.display='none'; loaderTxt.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞..."; showToast("–û—à–∏–±–∫–∞: " + e, true); });
      }

      function addRef(e){ e.preventDefault(); const b=document.getElementById('productSubmitBtn'),t=b.innerText; b.disabled=true; b.innerText='‚è≥';
        runBackend('addNewProduct', { name: document.getElementById('newPName').value, price: document.getElementById('newPPrice').value, cat: document.getElementById('newPCat').value })
        .then(r => { showToast(r.message, !r.success); b.disabled=false; b.innerText=t; if(r.success){ document.getElementById('newPName').value=''; document.getElementById('newPPrice').value=''; document.getElementById('newPCat').value=''; loadConfig(); }})
        .catch(err => { b.disabled=false; b.innerText=t; showToast("Error: " + err, true); });
      }

      function loadAnalytics(){ document.getElementById('loader').style.display = 'flex';
        let p = 'month', m = document.getElementById('anMonth').value;
        if(m === 'all') { p = 'year'; m = 0;
        }
        runBackend('getAnalyticsData', { period: p, mIdx: m, yr: document.getElementById('anYear').value, city: document.getElementById('anCity').value })
        .then(d => { drawAnalytics(d); document.getElementById('loader').style.display = 'none'; }).catch(e => { document.getElementById('loader').style.display = 'none'; showToast("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: " + e, true); });
      }
      function showToast(m,e=false){const x=document.getElementById("toast");x.innerText=m;x.className=e?"toast show error":"toast show success";setTimeout(()=>x.className=x.className.replace("show",""),3000);}
      function changeQty(d){const e=document.getElementById('qty');let v=parseInt(e.value)||0;v+=d;if(v<1)v=1;e.value=v;calcTotal();}
      function base64ToBlob(base64) { const b = window.atob(base64), len = b.length, bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = b.charCodeAt(i); return new Blob([bytes], { type: 'application/pdf' });
      }
      function fillSel(id,a,p){const e=document.getElementById(id),s=e.value;e.innerHTML='';if(id==='anCity')e.add(new Option('–í—Å–µ –≥–æ—Ä–æ–¥–∞','All'));if(p)e.add(new Option(p,''));a.forEach(x=>e.add(new Option(x,x)));if(s&&Array.from(e.options).some(o=>o.value===s))e.value=s;}
      function smartSearch(e){const v=e.target.value.toLowerCase(),l=document.getElementById('resList');l.innerHTML='';if(!v){l.style.display='none';return;}const m=PRODUCTS.filter(p=>p.name.toLowerCase().includes(v)).slice(0,10);if(m.length){l.style.display='block';m.forEach(p=>{const d=document.createElement('div');d.className='res-item';d.innerHTML=`<span><b>${p.name}</b> <small>(${p.category})</small></span><span>${p.price} ‚ÇΩ</span>`;d.onclick=()=>{document.getElementById('searchInp').value=p.name;document.getElementById('prodName').value=p.name;l.style.display='none';calcTotal()};l.appendChild(d)})}else{l.style.display='none'}}
      function calcTotal(){const n=document.getElementById('searchInp').value,q=document.getElementById('qty').value,p=PRODUCTS.find(x=>x.name.toLowerCase()===n.toLowerCase()),pr=p?p.price:0;document.getElementById('totalPreview').innerText=(pr*q)+" ‚ÇΩ"}
      function toggleAll(source) { document.querySelectorAll('.ship-chk').forEach(cb => cb.checked = source.checked);
      }
      function filterRef(){const v=document.getElementById('filterRef').value.toLowerCase();document.querySelectorAll('#refTable tbody tr').forEach(r=>{ 
         const txt = r.querySelector('input[id^="p-name"]').value + " " + r.querySelector('input[id^="p-cat"]').value;
         r.style.display = txt.toLowerCase().includes(v) ? '' : 'none';
      })}
      
      // === –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ì–†–ê–§–ò–ö–ò (–¢–û–ù–¨–®–ï, –î–ò–ê–ì–û–ù–ê–õ–¨, –ì–†–£–ü–ü–ò–†–û–í–ö–ê) ===
      function drawAnalytics(d) { 
        LAST_DATA = d;
        const g = d.prevRev > 0 ? ((d.totalRev - d.prevRev)/d.prevRev)*100 : 0;
        
        // 1. KPI
        document.getElementById('kpi').innerHTML=`<div class="card"><div class="card-lbl">–í—ã—Ä—É—á–∫–∞</div><div class="card-val" style="color:var(--accent)">${d.totalRev.toLocaleString()} ‚ÇΩ</div><div class="trend-badge ${g>=0?'trend-up':'trend-down'}">${g>=0?'‚Üë':'‚Üì'} ${Math.abs(g).toFixed(1)}%</div><div class="sub-text">–ü—Ä–æ—à–ª—ã–π: ${d.prevRev.toLocaleString()} ‚ÇΩ</div></div><div class="card"><div class="card-lbl">–í –æ–∂–∏–¥–∞–Ω–∏–∏</div><div class="card-val" style="color:#f59e0b">${d.pend.toLocaleString()} ‚ÇΩ</div><div class="sub-text">–≠—Ç–æ <b>${(d.totalRev+d.pend)>0?((d.pend/(d.totalRev+d.pend))*100).toFixed(1):0}%</b> –æ—Ç –≤—Å–µ–≥–æ –æ–±—ä–µ–º–∞</div></div><div class="card"><div class="card-lbl">–ó–∞–∫–∞–∑—ã</div><div class="card-val">${d.count}</div><div class="sub-text">–£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div></div><div class="card"><div class="card-lbl">–°—Ä. –ß–µ–∫</div><div class="card-val" style="color:var(--success)">${d.avg.toLocaleString()} ‚ÇΩ</div></div>`; 
        
        const th=document.body.getAttribute('data-theme');
        const c=th==='dark'?'#cbd5e1':'#64748b';
        const gridColor=th==='dark'?'rgba(255,255,255,0.1)':'rgba(0,0,0,0.05)';
        const isMobile = window.innerWidth < 768;

        // 2. –í–´–†–£–ß–ö–ê (–¢–æ–Ω–∫–∏–µ —Å—Ç–æ–ª–±—Ü—ã + –î–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç)
        renderChart('chartTrend', 'bar', {
            labels: d.trendL, 
            datasets: [{
                label: '–í—ã—Ä—É—á–∫–∞', 
                data: d.trendD, 
                backgroundColor: '#3b82f6', 
                borderRadius: 4,
                barPercentage: 0.6, // –¢–û–ù–¨–®–ï
                categoryPercentage: 0.8
            }]
        }, {
            maintainAspectRatio: false, 
            scales: {
                x: { 
                    grid: { display:false }, 
                    ticks: {
                        color: c, 
                        autoSkip: true,
                        maxRotation: 45, // –î–ò–ê–ì–û–ù–ê–õ–¨
                        minRotation: 45
                    } 
                }, 
                y: { grid:{color:gridColor}, ticks:{color:c} }
            }
        }); 

        // 3. –ì–û–†–û–î–ê (–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¢–æ–ø-5)
        let cityLabels = [], cityData = [];
        if(d.cityStats) {
            const sorted = Object.entries(d.cityStats).sort((a,b) => b[1] - a[1]);
            const top = sorted.slice(0, 5); // –¢–û–õ–¨–ö–û 5
            const others = sorted.slice(5).reduce((acc, curr) => acc + curr[1], 0);

            cityLabels = top.map(x => x[0]);
            cityData = top.map(x => x[1]);
            
            if (others > 0) {
                cityLabels.push('–î—Ä—É–≥–∏–µ');
                cityData.push(others);
            }
        }

        renderChart('chartCity', 'doughnut', {
            labels: cityLabels, 
            datasets: [{
                data: cityData, 
                backgroundColor: ['#3b82f6','#8b5cf6','#10b981','#f59e0b','#ef4444','#6366f1','#ec4899','#14b8a6'], 
                borderWidth: 0
            }]
        }, {
            maintainAspectRatio: false, 
            layout: { padding: { bottom: 5, top: 5 } }, 
            plugins: {
                legend: {
                    position: isMobile ? 'bottom' : 'right', // –õ–ï–ì–ï–ù–î–ê –°–ù–ò–ó–£
                    labels: { color:c, font:{size:11}, boxWidth:12, padding: 10 }
                }
            }
        });

        // 4. –ö–ê–¢–ï–ì–û–†–ò–ò (–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¢–æ–ø-8)
        let catLabels = [], catData = [];
        if(d.catStats) {
             const sorted = Object.entries(d.catStats).sort((a,b) => b[1] - a[1]);
             const top = sorted.slice(0, 8); // –¢–û–õ–¨–ö–û 8
             const others = sorted.slice(8).reduce((acc, curr) => acc + curr[1], 0);

             catLabels = top.map(x => x[0]);
             catData = top.map(x => x[1]);

             if (others > 0) {
                 catLabels.push('–î—Ä—É–≥–∏–µ');
                 catData.push(others);
             }
        }

        renderChart('chartCat', 'bar', {
            labels: catLabels, 
            datasets: [{label:'–ü—Ä–æ–¥–∞–∂–∏', data:catData, backgroundColor:'#8b5cf6', borderRadius:4}]
        }, {
            indexAxis: 'y', 
            maintainAspectRatio: false,
            scales: {
                x: { grid:{color:gridColor}, ticks:{color:c} },
                y: { grid:{display:false}, ticks:{color:c} }
            }
        }); 
        
        // 5. –¢–∞–±–ª–∏—Ü–∞
        const tb = document.querySelector('#topTable tbody'); tb.innerHTML = '';
        if (d.top) d.top.forEach(x => { 
           const tr=document.createElement('tr'); 
           tr.innerHTML=`<td>${x.name}</td><td style="text-align:right"><b>${x.val.toLocaleString()} ‚ÇΩ</b></td>`; 
           tb.appendChild(tr); 
        });
      }

      function renderChart(id, type, data, opts) { if(CHARTS[id]) CHARTS[id].destroy(); const ctx = document.getElementById(id).getContext('2d');
        const d={ maintainAspectRatio:false, plugins:{legend:{display:false}} }; CHARTS[id] = new Chart(ctx, { type:type, data:data, options:{...d, ...opts, plugins:{...d.plugins, ...opts.plugins}} });
      }
      function tab(i){document.querySelectorAll('.tab-page').forEach(e=>e.classList.remove('active'));document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));document.getElementById(i).classList.add('active');event.target.classList.add('active');if(i==='Unshipped')loadUnshippedTable()}
      
      function toggleTheme(){ 
        const b=document.body,d=b.getAttribute('data-theme')==='dark'; 
        b.setAttribute('data-theme',d?'light':'dark'); 
        localStorage.setItem('crm_theme',d?'light':'dark');
        if(LAST_DATA) { drawAnalytics(LAST_DATA); } else { loadAnalytics(); } 
      }

      // ==========================================
      // ü§ñ –†–û–ë–û–¢: –õ–û–ì–ò–ö–ê (HOVER = –ó–õ–û–°–¢–¨, BUTTON = WINK)
      // ==========================================
      (function initRobot() {
          const canvas = document.getElementById('robotCanvas');
          if (!canvas) return;
          const ctx = canvas.getContext('2d');

          let width = 300, height = 300; 
          let centerX = width / 2, centerY = height / 2;

          const mouse = { x: 0, y: 0 };
          const currentLook = { x: 0, y: 0 };
          const targetLook = { x: 0, y: 0 };
          
          let isIdle = false;
          let isAngry = false;
          let isBlinking = false;
          let isWinking = false; 
          let idleTimer = null;
          let currentRightHeight = 120;

          const eyeState = {
              width: 90, height: 120,
              rTopLeft: 20, rTopRight: 20, rBotRight: 20, rBotLeft: 20,
              r: 0, g: 210, b: 255,
              rotation: 0
          };

          function resetIdleTimer() {
              if (isAngry) return;
              isIdle = false;
              clearTimeout(idleTimer);
              idleTimer = setTimeout(() => { isIdle = true; triggerRandomLook(); }, 2500);
          }

          document.addEventListener('mousemove', e => {
              const winCX = window.innerWidth / 2;
              const winCY = window.innerHeight / 2;
              mouse.x = (e.clientX - winCX) / (winCX * 0.8);
              mouse.y = (e.clientY - winCY) / (winCY * 0.8);
              mouse.x = Math.max(-1.5, Math.min(1.5, mouse.x));
              mouse.y = Math.max(-1.5, Math.min(1.5, mouse.y));

              if (!isAngry) {
                  targetLook.x = mouse.x;
                  targetLook.y = mouse.y;
              }
              resetIdleTimer();
          });

          const robotContainer = document.getElementById('robotContainer');
          
          robotContainer.addEventListener('mouseenter', () => { isAngry = true; targetLook.x = 0; targetLook.y = 0; });
          robotContainer.addEventListener('mouseleave', () => { isAngry = false; resetIdleTimer(); });
          
          robotContainer.addEventListener('touchstart', (e) => { isAngry = true; targetLook.x = 0; targetLook.y = 0; }, {passive: true});
          robotContainer.addEventListener('touchend', () => { isAngry = false; resetIdleTimer(); });

          document.addEventListener('click', (e) => {
             if (e.target.tagName === 'BUTTON' || e.target.closest('button') || e.target.classList.contains('nav-btn')) {
                 triggerWink();
             }
          });

          function triggerWink() {
             if (isWinking || isBlinking) return;
             isWinking = true;
             setTimeout(() => { isWinking = false; }, 300);
          }

          function triggerRandomLook() {
              if (!isIdle || isAngry) return;
              targetLook.x = (Math.random() - 0.5) * 1.5;
              targetLook.y = (Math.random() - 0.5) * 1.0;
              setTimeout(triggerRandomLook, Math.random() * 2000 + 2000);
          }

          function triggerBlink() {
              if (!document.hidden && !isBlinking && !isWinking && !isAngry) {
                  isBlinking = true;
                  setTimeout(() => { isBlinking = false; }, 150);
              }
              setTimeout(triggerBlink, Math.random() * 4000 + 2000);
          }
          setTimeout(triggerBlink, 2000);

          function lerp(start, end, factor) { return start + (end - start) * factor; }

          function drawEye(ctx, x, y, w, h, state, isLeft) {
              ctx.save();
              ctx.translate(x, y);
              const dir = isLeft ? -1 : 1;
              ctx.rotate(state.rotation * dir);
              ctx.beginPath();
              const hw = w / 2, hh = h / 2;
              const safeH = Math.max(h, 0), maxR = safeH / 2;
              const rTL = Math.min(state.rTopLeft, maxR), rTR = Math.min(state.rTopRight, maxR), rBR = Math.min(state.rBotRight, maxR), rBL = Math.min(state.rBotLeft, maxR);

              ctx.moveTo(-hw + rTL, -hh);
              ctx.lineTo(hw - rTR, -hh);
              ctx.quadraticCurveTo(hw, -hh, hw, -hh + rTR);
              ctx.lineTo(hw, hh - rBR);
              ctx.quadraticCurveTo(hw, hh, hw - rBR, hh);
              ctx.lineTo(-hw + rBL, hh);
              ctx.quadraticCurveTo(-hw, hh, -hw, hh - rBL);
              ctx.lineTo(-hw, -hh + rTL);
              ctx.quadraticCurveTo(-hw, -hh, -hw + rTL, -hh);
              ctx.closePath();

              ctx.fillStyle = `rgb(${state.r}, ${state.g}, ${state.b})`;
              const isClosed = (h < 10);
              ctx.shadowBlur = isClosed ? 40 : 25; 
              ctx.shadowColor = `rgba(${state.r}, ${state.g}, ${state.b}, ${isClosed ? 0.9 : 0.6})`;
              ctx.fill();
              ctx.restore();
          }

          function animate() {
              ctx.clearRect(0, 0, width, height);
              
              let targetState = {};
              if (isAngry) {
                  targetState = { width: 95, height: 90, rTopLeft: 5, rTopRight: 40, rBotRight: 40, rBotLeft: 5, r: 255, g: 0, b: 50, rotation: 15 * (Math.PI / 180) };
              } else if (isIdle) {
                  targetState = { width: 90, height: 120, rTopLeft: 20, rTopRight: 20, rBotRight: 20, rBotLeft: 20, r: 0, g: 210, b: 255, rotation: 0 };
              } else {
                  targetState = { width: 95, height: 85, rTopLeft: 45, rTopRight: 45, rBotRight: 25, rBotLeft: 25, r: 0, g: 255, b: 170, rotation: 0 };
              }

              if (isBlinking) {
                  targetState.height = 4; targetState.width = 95; targetState.r = 255; targetState.g = 255; targetState.b = 255; targetState.rotation = 0;
              }

              let speed = 0.1;
              if (isBlinking) speed = 0.35;
              else if (eyeState.height < 20) speed = 0.25;

              eyeState.width = lerp(eyeState.width, targetState.width, speed);
              eyeState.height = lerp(eyeState.height, targetState.height, speed); 
              
              eyeState.rotation = lerp(eyeState.rotation, targetState.rotation, speed);
              eyeState.rTopLeft = lerp(eyeState.rTopLeft, targetState.rTopLeft, speed);
              eyeState.rTopRight = lerp(eyeState.rTopRight, targetState.rTopRight, speed);
              eyeState.rBotRight = lerp(eyeState.rBotRight, targetState.rBotRight, speed);
              eyeState.rBotLeft = lerp(eyeState.rBotLeft, targetState.rBotLeft, speed);
              eyeState.r = lerp(eyeState.r, targetState.r, speed);
              eyeState.g = lerp(eyeState.g, targetState.g, speed);
              eyeState.b = lerp(eyeState.b, targetState.b, speed);

              let targetRightH = targetState.height;
              if (isWinking) {
                  targetRightH = 4; 
              }
              
              let speedRight = isWinking ? 0.35 : speed; 
              currentRightHeight = lerp(currentRightHeight, targetRightH, speedRight);

              currentLook.x = lerp(currentLook.x, targetLook.x, 0.08);
              currentLook.y = lerp(currentLook.y, targetLook.y, 0.08);
              
              const shake = isAngry ? 3 : 0;
              const moveX = (currentLook.x * 35) + (Math.random() - 0.5) * shake; 
              const moveY = (currentLook.y * 25) + (Math.random() - 0.5) * shake;

              const eyeGap = 60; 

              drawEye(ctx, centerX - eyeGap + moveX, centerY + moveY, eyeState.width, eyeState.height, eyeState, true);
              drawEye(ctx, centerX + eyeGap + moveX, centerY + moveY, eyeState.width, currentRightHeight, eyeState, false);

              requestAnimationFrame(animate);
          }
          animate();
      })();
    </script>
  </body>
</html>
