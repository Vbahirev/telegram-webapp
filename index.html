<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
      /* –í–ï–°–¨ –í–ê–® –°–¢–ò–õ–¨ –°–û–•–†–ê–ù–ï–ù */
      :root { --bg-app: #f8fafc; --bg-panel: #ffffff; --text-main: #0f172a; --text-sub: #64748b; --accent: #3b82f6; --border: #cbd5e1; --input-bg: #ffffff; --success: #10b981; --danger: #ef4444; --card-kpi-bg: #ffffff; --arrow-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); }
      [data-theme="dark"] { --bg-app: #0f172a; --bg-panel: #1e293b; --text-main: #f8fafc; --text-sub: #94a3b8; --accent: #60a5fa; --border: #475569; --input-bg: #0f172a; --card-kpi-bg: #1e293b; --arrow-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2360a5fa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); }
      body { margin: 0; padding: 20px; font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-main); transition: 0.3s; height: 100vh; box-sizing: border-box; overflow: hidden; }
      .app-wrapper { display: flex; flex-direction: column; height: 100%; gap: 15px; max-width: 1200px; margin: 0 auto; width: 100%; }
      .toast { visibility: hidden; min-width: 250px; background-color: var(--text-main); color: var(--bg-app); text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transition: 0.3s; }
      .toast.show { visibility: visible; opacity: 1; bottom: 50px; }
      .toast.success { background-color: var(--success); color: white; }
      .toast.error { background-color: var(--danger); color: white; }
      .header { display: flex; justify-content: space-between; align-items: center; }
      .title { margin: 0; font-size: 22px; font-weight: 800; }
      .nav { display: flex; gap: 8px; flex-wrap: wrap; }
      .nav-btn { padding: 10px 18px; border: 1px solid var(--border); background: var(--bg-panel); color: var(--text-sub); border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; white-space: nowrap; }
      .nav-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
      .content-area { flex: 1; position: relative; overflow: hidden; background-color: var(--bg-panel); border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.05); z-index: 10; }
      .tab-page { display: none; height: 100%; overflow-y: auto; padding: 30px; box-sizing: border-box; -webkit-overflow-scrolling: touch; }
      .tab-page.active { display: block; }
      label { font-size: 11px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin-bottom: 5px; display: block; }
      input, select { width: 100%; padding: 12px 15px; border-radius: 10px; border: 2px solid var(--border); background-color: var(--input-bg); color: var(--text-main); font-family: 'Inter'; font-size: 14px; font-weight: 500; outline: none; box-sizing: border-box; transition: 0.2s; }
      input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
      select { appearance: none; -webkit-appearance: none; background-image: var(--arrow-icon); background-repeat: no-repeat; background-position: right 12px center; background-size: 18px; padding-right: 40px; cursor: pointer; }
      .qty-wrapper { display: flex; align-items: center; justify-content: center; background-color: var(--input-bg); border: 2px solid var(--border); border-radius: 10px; overflow: hidden; height: 46px; }
      .qty-btn { width: 50px; height: 100%; background: transparent; border: none; color: var(--text-main); font-size: 20px; font-weight: 700; cursor: pointer; }
      .qty-input { width: 80px; text-align: center; border: none; background: transparent; font-weight: 700; font-size: 18px; padding: 0; height: 100%; }
      .btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.2s; }
      .btn-sm { width: auto; padding: 8px 20px; font-size: 13px; white-space: nowrap; }
      table { width: 100%; border-collapse: collapse; font-size: 13px; }
      th { text-align: left; padding: 12px; color: var(--text-sub); border-bottom: 1px solid var(--border); background: var(--input-bg); white-space: nowrap; }
      td { padding: 12px; border-bottom: 1px solid var(--border); }
      .w-check { width: 40px; text-align: center; }
      .w-check input { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); vertical-align: middle;}
      .search-box { position: relative; }
      .results-list { position: absolute; top: 105%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: var(--bg-panel); border: 2px solid var(--accent); border-radius: 10px; z-index: 100; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
      .res-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
      .res-item:hover { background: var(--input-bg); color: var(--accent); }
      .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 999; display: none; backdrop-filter: blur(4px); flex-direction: column; color: white; font-weight: 600; }
      .spin { width: 30px; height: 30px; border: 3px solid #fff; border-top-color: var(--accent); border-radius: 50%; animation: r 1s infinite linear; margin-bottom: 10px; }
      @keyframes r { to { transform: rotate(360deg); } }
      .theme-toggle { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-main); }
      @media (max-width: 768px) { body { padding: 10px; height: auto; overflow: auto; } .app-wrapper { height: auto; min-height: 100vh; } .content-area { border-radius: 12px; height: auto; overflow: visible; } .tab-page { padding: 15px; height: auto; overflow: visible; } .nav { flex-wrap: nowrap; overflow-x: auto; padding-bottom: 5px; } }
    </style>
  </head>
  <body>
    <div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
    <div class="loader" id="loader"><div class="spin"></div><div id="loaderTxt">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>

    <div class="app-wrapper">
      <div class="header"><h1 class="title">CRM <span style="color:var(--accent)">–ú–µ–Ω–µ–¥–∂–µ—Ä</span></h1><button class="theme-toggle" onclick="toggleTheme()">üåó</button></div>
      <div class="nav">
        <button class="nav-btn active" onclick="tab('Entry')">‚ûï –í–≤–æ–¥</button>
        <button class="nav-btn" onclick="tab('Unshipped')">üì¶ –û—Ç–≥—Ä—É–∑–∫–∞</button>
        <button class="nav-btn" onclick="tab('Ref')">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</button>
        <button class="nav-btn" onclick="tab('Analytics')">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
      </div>
      <div class="content-area">
        <div id="Entry" class="tab-page active">
           <div style="max-width: 500px; margin: 0 auto;">
             <h3>–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h3>
             <form id="formEntry">
               <div style="margin-bottom: 15px;"><label>–ì–æ—Ä–æ–¥ (–ú–∞–≥–∞–∑–∏–Ω)</label><select id="entryCity" required></select></div>
               <div class="search-box" style="margin-bottom: 15px;"><label>–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞</label><input type="text" id="searchInp" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å..." autocomplete="off" required><div class="results-list" id="resList"></div></div>
               <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                 <div><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label><div class="qty-wrapper"><button type="button" class="qty-btn" onclick="changeQty(-1)">‚àí</button><input type="number" id="qty" value="1" min="1" class="qty-input" required><button type="button" class="qty-btn" onclick="changeQty(1)">+</button></div></div>
                 <div><label>–ò—Ç–æ–≥–æ</label><div id="totalPreview" style="padding: 12px; font-weight: 700; color: var(--accent); font-size:18px;">0 ‚ÇΩ</div></div>
               </div>
               <button type="submit" class="btn" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
             </form>
           </div>
        </div>
        <div id="Unshipped" class="tab-page">
           <div style="background: var(--input-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border);">
             <label style="font-size:13px; margin-bottom:10px;">–í–´–ë–ï–†–ò–¢–ï –ì–û–†–û–î –î–õ–Ø –û–¢–ì–†–£–ó–ö–ò:</label>
             <div style="display:flex; gap: 15px; width: 100%; flex-wrap: wrap;">
               <select id="shipCity" style="flex:1" onchange="loadUnshippedTable()"></select>
               <button class="btn btn-sm" onclick="loadUnshippedTable()">–û–±–Ω–æ–≤–∏—Ç—å</button>
             </div>
           </div>
           <div id="unshippedContent"><div style="text-align:center; margin-top: 50px;">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤—ã—à–µ</div></div>
        </div>
        <div id="Ref" class="tab-page">
           <div style="text-align:center; padding:20px;"><h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
           <form id="formRef">
             <input id="newPName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
             <input id="newPPrice" type="number" placeholder="–¶–µ–Ω–∞" required>
             <input id="newPCat" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è" required>
             <button type="submit" class="btn" id="productSubmitBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
           </form>
           </div>
        </div>
        <div id="Analytics" class="tab-page"><div style="text-align:center; padding:20px;">–†–∞–∑–¥–µ–ª –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</div></div>
      </div>
    </div>

    <script>
      let CONFIG = {}, PRODUCTS = [];
      const tg = window.Telegram.WebApp;
      tg.expand();

      // ==========================================
      // üëá –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–£ –ù–û–í–£–Æ –°–°–´–õ–ö–£
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbwda6r_4pClRmRuAetUeD5KGHRhLhiv-8ZexKQMvfFo_mwOfc1Fpjr04Yw9ddBHuK9w/exec';
      // ==========================================

      const IS_GOOGLE = typeof google !== 'undefined' && google.script && google.script.run;

      async function runBackend(action, data = {}) {
        if (IS_GOOGLE) {
           // –†–µ–∂–∏–º "–í–Ω—É—Ç—Ä–∏ —Ç–∞–±–ª–∏—Ü—ã"
           return new Promise((resolve, reject) => {
              const h = google.script.run.withSuccessHandler(resolve).withFailureHandler(reject);
              if(action==='getInitialConfig') h.getInitialConfig();
              else if(action==='saveNewEntry') h.saveNewEntry(data);
              else if(action==='getUnshippedForCity') h.getUnshippedForCity(data.city);
              else if(action==='shipAndGeneratePdf') h.shipAndGeneratePdf(data.city, data.items);
              else if(action==='addNewProduct') h.addNewProduct(data.name, data.price, data.cat);
              else reject("Unknown action");
           });
        } else {
           // –†–µ–∂–∏–º "–¢–µ–ª–µ–≥—Ä–∞–º" —á–µ—Ä–µ–∑ AllOrigins (JSON)
           const targetUrl = new URL(GAS_URL);
           targetUrl.searchParams.append('action', action);
           targetUrl.searchParams.append('data', JSON.stringify(data));
           if(data.city) targetUrl.searchParams.append('city', data.city);

           // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç –≤ JSON, –∏–∑–±–µ–≥–∞—è –æ—à–∏–±–∫–∏ <
           const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl.toString())}`;
           
           try {
             const response = await fetch(proxy);
             if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + response.status);
             
             const wrapped = await response.json();
             // AllOrigins –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª–µ .contents
             // –ï—Å–ª–∏ contents —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, –ø–∞—Ä—Å–∏–º –µ—ë
             return JSON.parse(wrapped.contents);

           } catch (e) {
             throw new Error("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: " + e.message + ". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Deployment.");
           }
        }
      }

      window.onload = () => { 
        document.getElementById('loader').style.display='flex'; 
        loadConfig(); 
        document.getElementById('formEntry').onsubmit=saveEntry; 
        document.getElementById('formRef').onsubmit=addRef; 
        document.getElementById('searchInp').oninput=smartSearch; 
        document.getElementById('qty').oninput=calcTotal; 
        if(localStorage.getItem('crm_theme')==='dark') document.body.setAttribute('data-theme','dark'); 
      };

      async function loadConfig(){
        try {
          const c = await runBackend('getInitialConfig');
          CONFIG = c; PRODUCTS = c.products; 
          fillSel('entryCity', c.cities); 
          fillSel('shipCity', c.cities); 
          document.getElementById('loader').style.display='none'; 
        } catch(e) {
          document.getElementById('loaderTxt').innerText = "–û—à–∏–±–∫–∞: " + e;
        }
      }

      async function saveEntry(e){
         e.preventDefault(); const b=document.getElementById('saveBtn'); b.disabled=true; b.innerText='‚è≥...';
         try {
           const r = await runBackend('saveNewEntry', {
             city: document.getElementById('entryCity').value,
             productName: document.getElementById('searchInp').value,
             quantity: document.getElementById('qty').value
           });
           showToast(r.message, !r.success);
           if(r.success) { document.getElementById('searchInp').value=''; document.getElementById('qty').value=1; calcTotal(); }
         } catch(err) { showToast("Error: "+err, true); }
         finally { b.disabled=false; b.innerText='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; }
      }

      async function loadUnshippedTable(){
        const c=document.getElementById('shipCity').value, d=document.getElementById('unshippedContent');
        if(!c)return; d.innerHTML='<div style="text-align:center; padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>'; 
        try {
           const i = await runBackend('getUnshippedForCity', {city: c});
           if(!i.length){d.innerHTML='<div style="text-align:center; padding:20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';return;}
           let h = '<table><thead><tr><th>–¢–æ–≤–∞—Ä</th><th>–ö–æ–ª</th><th>–°—É–º–º–∞</th></tr></thead><tbody>';
           i.forEach(x => { h+=`<tr><td>${x.name}</td><td>${x.qty}</td><td>${x.total}</td></tr>` });
           h+='</tbody></table>';
           h+=`<button class="btn" onclick='doShip("${c}", ${JSON.stringify(i)})' style="margin-top:10px">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å PDF</button>`;
           d.innerHTML = h;
        } catch(e) { d.innerHTML="–û—à–∏–±–∫–∞: "+e; }
      }

      async function doShip(city, items){
         if(!confirm("–°–æ–∑–¥–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—É—é?")) return;
         document.getElementById('loader').style.display='flex';
         try {
            const r = await runBackend('shipAndGeneratePdf', {city: city, items: items});
            if(r.success) {
               const bin = atob(r.pdfData);
               const bytes = new Uint8Array(bin.length);
               for (let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
               const blob = new Blob([bytes], {type: 'application/pdf'});
               const url = window.URL.createObjectURL(blob);
               window.open(url);
               loadUnshippedTable();
            } else { showToast(r.message, true); }
         } catch(e) { showToast("Err: "+e, true); }
         document.getElementById('loader').style.display='none';
      }

      async function addRef(e){
         e.preventDefault(); const b=document.getElementById('productSubmitBtn'); b.disabled=true;
         try {
            const r = await runBackend('addNewProduct', {
               name: document.getElementById('newPName').value,
               price: document.getElementById('newPPrice').value,
               cat: document.getElementById('newPCat').value
            });
            showToast(r.message, !r.success);
            if(r.success) e.target.reset();
         } catch(e) { showToast("Err: "+e, true); }
         b.disabled=false;
      }

      // –•–µ–ª–ø–µ—Ä—ã
      function fillSel(id, arr) { const s = document.getElementById(id); s.innerHTML=''; arr.forEach(x => s.add(new Option(x,x))); }
      function smartSearch(e){ 
         const v=e.target.value.toLowerCase(), l=document.getElementById('resList'); l.innerHTML=''; 
         if(!v){l.style.display='none';return;}
         const m = PRODUCTS.filter(p => p.name.toLowerCase().includes(v)).slice(0,8);
         if(m.length) {
            l.style.display='block';
            m.forEach(p => {
               const d=document.createElement('div'); d.className='res-item';
               d.innerHTML=`<b>${p.name}</b> <span>${p.price}</span>`;
               d.onclick=()=>{ document.getElementById('searchInp').value=p.name; l.style.display='none'; calcTotal(); };
               l.appendChild(d);
            });
         } else l.style.display='none';
      }
      function calcTotal(){ 
         const n=document.getElementById('searchInp').value, q=document.getElementById('qty').value;
         const p=PRODUCTS.find(x=>x.name===n);
         document.getElementById('totalPreview').innerText = p ? (p.price*q)+" ‚ÇΩ" : "0 ‚ÇΩ";
      }
      function showToast(m,e){const x=document.getElementById("toast");x.innerText=m;x.className=e?"toast show error":"toast show success";setTimeout(()=>x.className=x.className.replace("show",""),3000);}
      function tab(i){document.querySelectorAll('.tab-page').forEach(e=>e.classList.remove('active'));document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));document.getElementById(i).classList.add('active');event.target.classList.add('active');if(i==='Unshipped')loadUnshippedTable()}
      function toggleTheme(){const b=document.body,d=b.getAttribute('data-theme')==='dark';b.setAttribute('data-theme',d?'light':'dark');localStorage.setItem('crm_theme',d?'light':'dark');}
    </script>
  </body>
</html>
