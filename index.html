<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
      /* –°—Ç–∏–ª–∏ —Ç–µ –∂–µ —Å–∞–º—ã–µ, —Å–∂–∞—Ç—ã –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ */
      :root { --bg: #f8fafc; --panel: #fff; --text: #0f172a; --accent: #3b82f6; --border: #cbd5e1; --err: #ef4444; --succ: #10b981; }
      [data-theme="dark"] { --bg: #0f172a; --panel: #1e293b; --text: #f8fafc; --accent: #60a5fa; --border: #475569; }
      body { margin:0; padding:20px; font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); height:100vh; overflow:hidden; box-sizing:border-box; }
      .app-wrapper { display:flex; flex-direction:column; height:100%; gap:15px; max-width:800px; margin:0 auto; }
      .nav { display:flex; gap:10px; overflow-x:auto; padding-bottom:5px; }
      .nav-btn { padding:10px 15px; border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:8px; cursor:pointer; white-space:nowrap; }
      .nav-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
      .content { flex:1; background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow-y:auto; padding:20px; position:relative; }
      .tab { display:none; } .tab.active { display:block; }
      input, select, button { width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text); box-sizing:border-box; }
      button.btn-primary { background:var(--accent); color:#fff; border:none; font-weight:bold; cursor:pointer; }
      .loader { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; color:#fff; z-index:999; display:none; flex-direction:column; }
      .toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:10px 20px; border-radius:8px; display:none; z-index:1000; }
      .toast.error { background:var(--err); } .toast.success { background:var(--succ); }
      
      /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Å–∫—Ä–æ–ª–ª */
      ::-webkit-scrollbar { width:6px; } ::-webkit-scrollbar-thumb { background:#ccc; border-radius:3px; }
    </style>
  </head>
  <body>
    <div id="loader" class="loader"><div style="font-size:30px;">‚è≥</div><div id="loaderTxt">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
    <div id="toast" class="toast"></div>

    <div class="app-wrapper">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">CRM –°–∏—Å—Ç–µ–º–∞</h2>
        <button onclick="toggleTheme()" style="width:auto; background:none; border:none; font-size:20px;">üåó</button>
      </div>
      
      <div class="nav">
        <button class="nav-btn active" onclick="switchTab('Entry')">‚ûï –í–≤–æ–¥</button>
        <button class="nav-btn" onclick="switchTab('Unshipped')">üì¶ –û—Ç–≥—Ä—É–∑–∫–∞</button>
        <button class="nav-btn" onclick="switchTab('Ref')">üìö –¢–æ–≤–∞—Ä—ã</button>
      </div>

      <div class="content">
        <div id="Entry" class="tab active">
          <h3>–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h3>
          <form onsubmit="handleSaveEntry(event)">
            <label>–ì–æ—Ä–æ–¥</label>
            <select id="entryCity" required></select>
            
            <label>–¢–æ–≤–∞—Ä (–ü–æ–∏—Å–∫)</label>
            <input id="searchInp" oninput="doSearch(this.value)" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å..." autocomplete="off" required>
            <div id="resList" style="border:1px solid var(--accent); border-radius:5px; max-height:150px; overflow-y:auto; display:none; margin-top:-10px; margin-bottom:10px;"></div>
            
            <div style="display:flex; gap:10px;">
              <div style="flex:1"><label>–ö–æ–ª-–≤–æ</label><input type="number" id="qty" value="1" min="1" oninput="calcTotal()"></div>
              <div style="flex:1; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:18px; color:var(--accent);" id="totalPreview">0 ‚ÇΩ</div>
            </div>
            
            <button type="submit" class="btn-primary" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </form>
        </div>

        <div id="Unshipped" class="tab">
          <div style="display:flex; gap:10px;">
            <select id="shipCity" onchange="loadUnshippedTable()"></select>
            <button style="width:auto;" onclick="loadUnshippedTable()">üîÑ</button>
          </div>
          <div id="unshippedList"></div>
        </div>

        <div id="Ref" class="tab">
           <h3>–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫</h3>
           <form onsubmit="handleAddProduct(event)">
             <input id="newPName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
             <input id="newPPrice" type="number" placeholder="–¶–µ–Ω–∞" required>
             <input id="newPCat" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">
             <button type="submit" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
           </form>
        </div>
      </div>
    </div>

    <script>
      // ==========================================
      // üëá –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–£ –°–°–´–õ–ö–£ (Exec URL)
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbyKA_TUAMbt0Dknl6kPbISyq7_3hY-KPo0LA4y7eOWzRVmYpTidOizNaiixdV06dhO_/exec';
      // ==========================================

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≥–¥–µ –º—ã: –í –ì—É–≥–ª–µ –∏–ª–∏ –í –¢–µ–ª–µ–≥—Ä–∞–º–µ?
      const IS_GOOGLE = typeof google !== 'undefined' && google.script;
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      let CONFIG = {}, PRODUCTS = [];
      const tg = window.Telegram.WebApp;
      tg.expand();
      
      window.onload = () => {
         document.getElementById('loader').style.display='flex';
         initApp();
         if(localStorage.getItem('theme')==='dark') document.body.setAttribute('data-theme','dark');
      };

      // --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø-–ü–ï–†–ï–•–û–î–ù–ò–ö (HYBRID API) ---
      async function runBackend(action, data = {}) {
        if (IS_GOOGLE) {
           // –†–µ–∂–∏–º "–í–Ω—É—Ç—Ä–∏ –¢–∞–±–ª–∏—Ü—ã" - –∏—Å–ø–æ–ª—å–∑—É–µ–º google.script.run
           return new Promise((resolve, reject) => {
              // –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏ GAS
              if(action === 'getInitialConfig') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getInitialConfig();
              else if(action === 'saveNewEntry') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).saveNewEntry(data);
              else if(action === 'getUnshippedForCity') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getUnshippedForCity(data.city);
              else if(action === 'shipAndGeneratePdf') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).shipAndGeneratePdf(data.city, data.items);
              else if(action === 'addNewProduct') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).addNewProduct(data.name, data.price, data.cat);
              else reject("Unknown action in Google Mode");
           });
        } else {
           // –†–µ–∂–∏–º "–¢–µ–ª–µ–≥—Ä–∞–º/–í–µ–±" - –∏—Å–ø–æ–ª—å–∑—É–µ–º fetch —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
           // –ò—Å–ø–æ–ª—å–∑—É–µ–º corsproxy.io, –µ—Å–ª–∏ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç. –ï—Å–ª–∏ –Ω–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ 'https://api.allorigins.win/get?url='
           const proxy = 'https://corsproxy.io/?'; 
           const targetUrl = new URL(GAS_URL);
           targetUrl.searchParams.append('action', action);
           targetUrl.searchParams.append('data', JSON.stringify(data));
           // –î–ª—è city –æ—Ç–¥–µ–ª—å–Ω–æ
           if(data.city) targetUrl.searchParams.append('city', data.city);

           const response = await fetch(proxy + encodeURIComponent(targetUrl.toString()));
           if(!response.ok) throw new Error("Network error: " + response.status);
           return await response.json();
        }
      }

      // --- –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---

      async function initApp() {
         try {
           CONFIG = await runBackend('getInitialConfig');
           PRODUCTS = CONFIG.products || [];
           fillSel('entryCity', CONFIG.cities);
           fillSel('shipCity', CONFIG.cities);
         } catch(e) { showToast('–û—à–∏–±–∫–∞: ' + e, true); }
         finally { document.getElementById('loader').style.display='none'; }
      }

      async function handleSaveEntry(e) {
        e.preventDefault();
        const btn = document.getElementById('saveBtn'); btn.disabled=true; btn.innerText='‚è≥';
        try {
           const res = await runBackend('saveNewEntry', {
             city: document.getElementById('entryCity').value,
             productName: document.getElementById('searchInp').value,
             quantity: document.getElementById('qty').value
           });
           if(res.success) { 
             showToast(res.message); 
             document.getElementById('searchInp').value='';
             document.getElementById('qty').value=1;
             document.getElementById('totalPreview').innerText='0 ‚ÇΩ';
           } else { showToast(res.message, true); }
        } catch(err) { showToast("–û—à–∏–±–∫–∞: "+err, true); }
        btn.disabled=false; btn.innerText='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      }
      
      async function loadUnshippedTable() {
         const city = document.getElementById('shipCity').value;
         if(!city) return;
         document.getElementById('unshippedList').innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
         try {
            const list = await runBackend('getUnshippedForCity', {city: city});
            if(!list.length) { document.getElementById('unshippedList').innerHTML = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; return; }
            
            let html = `<div style="margin-bottom:10px;"><b>–í—Å–µ–≥–æ: ${list.length}</b> <button onclick='doShip("${city}", ${JSON.stringify(list)})' class="btn-primary" style="width:auto; float:right; font-size:12px;">–û—Ç–≥—Ä—É–∑–∏—Ç—å PDF</button></div>`;
            list.forEach(item => {
               html += `<div style="border-bottom:1px solid #eee; padding:5px;">
                 <div><b>${item.name}</b></div>
                 <div style="font-size:12px; color:#666;">${item.date} | ${item.qty} —à—Ç. | ${item.total} ‚ÇΩ</div>
               </div>`;
            });
            document.getElementById('unshippedList').innerHTML = html;
         } catch(e) { document.getElementById('unshippedList').innerHTML = 'Err: '+e; }
      }

      async function doShip(city, list) {
         if(!confirm('–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—É—é?')) return;
         document.getElementById('loader').style.display='flex';
         try {
            const res = await runBackend('shipAndGeneratePdf', {city: city, items: list});
            if(res.success) {
               // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Base64 –≤ —Ñ–∞–π–ª
               const bin = atob(res.pdfData);
               const bytes = new Uint8Array(bin.length);
               for (let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
               const blob = new Blob([bytes], {type: 'application/pdf'});
               const url = URL.createObjectURL(blob);
               window.open(url); // –û—Ç–∫—Ä—ã—Ç—å PDF
               loadUnshippedTable(); // –û–±–Ω–æ–≤–∏—Ç—å
            } else { showToast(res.message, true); }
         } catch(e) { showToast("Error: "+e, true); }
         document.getElementById('loader').style.display='none';
      }
      
      async function handleAddProduct(e) {
         e.preventDefault();
         try {
           const res = await runBackend('addNewProduct', {
             name: document.getElementById('newPName').value,
             price: document.getElementById('newPPrice').value,
             cat: document.getElementById('newPCat').value
           });
           showToast(res.message, !res.success);
           if(res.success) e.target.reset();
         } catch(e){ showToast("Err: "+e, true); }
      }

      // –•–µ–ª–ø–µ—Ä—ã
      function fillSel(id, arr) { 
         const s = document.getElementById(id); s.innerHTML='<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>'; 
         if(arr) arr.forEach(x => { let o = document.createElement('option'); o.value=x; o.innerText=x; s.appendChild(o); });
      }
      function doSearch(val) {
         const list = document.getElementById('resList');
         list.innerHTML=''; list.style.display='none';
         if(!val) return;
         const match = PRODUCTS.filter(p => p.name.toLowerCase().includes(val.toLowerCase())).slice(0, 10);
         if(match.length) {
            list.style.display='block';
            match.forEach(p => {
               const d = document.createElement('div');
               d.style.padding='8px'; d.style.cursor='pointer'; d.style.borderBottom='1px solid #eee';
               d.innerHTML = `<b>${p.name}</b> <span style="float:right">${p.price}‚ÇΩ</span>`;
               d.onclick = () => { 
                  document.getElementById('searchInp').value = p.name;
                  calcTotal();
                  list.style.display='none';
               };
               list.appendChild(d);
            });
         }
      }
      function calcTotal() {
         const name = document.getElementById('searchInp').value;
         const qty = document.getElementById('qty').value;
         const prod = PRODUCTS.find(p => p.name === name);
         const price = prod ? prod.price : 0;
         document.getElementById('totalPreview').innerText = (price * qty) + ' ‚ÇΩ';
      }
      function switchTab(id) {
         document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
         document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
         document.getElementById(id).classList.add('active');
         event.target.classList.add('active');
      }
      function showToast(msg, isErr) {
         const t = document.getElementById('toast');
         t.innerText = msg; t.className = 'toast ' + (isErr ? 'error' : 'success');
         t.style.display='block'; setTimeout(()=>t.style.display='none', 3000);
      }
      function toggleTheme() {
         const b = document.body;
         const t = b.getAttribute('data-theme')==='dark'?'light':'dark';
         b.setAttribute('data-theme', t);
         localStorage.setItem('theme', t);
      }
    </script>
  </body>
</html>
