<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
      :root {
        --bg-app: #f8fafc; --bg-panel: #ffffff; --text-main: #0f172a; --text-sub: #64748b;
        --accent: #3b82f6; --border: #cbd5e1; --input-bg: #ffffff;
        --success: #10b981; --danger: #ef4444; --card-kpi-bg: #ffffff;
      }
      [data-theme="dark"] {
        --bg-app: #0f172a; --bg-panel: #1e293b; --text-main: #f8fafc; --text-sub: #94a3b8;
        --accent: #60a5fa; --border: #475569; --input-bg: #0f172a; --card-kpi-bg: #1e293b;
      }
      body { margin: 0; padding: 20px; font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-main); height: 100vh; overflow: hidden; box-sizing: border-box; }
      .app-wrapper { display: flex; flex-direction: column; height: 100%; gap: 15px; max-width: 1200px; margin: 0 auto; width: 100%; }
      
      /* Toast */
      .toast { visibility: hidden; min-width: 250px; background-color: var(--text-main); color: var(--bg-app); text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); opacity: 0; transition: 0.3s; }
      .toast.show { visibility: visible; opacity: 1; bottom: 50px; }
      
      /* Nav */
      .header { display: flex; justify-content: space-between; align-items: center; }
      .title { margin: 0; font-size: 22px; font-weight: 800; }
      .nav { display: flex; gap: 8px; flex-wrap: wrap; }
      .nav-btn { padding: 10px 18px; border: 1px solid var(--border); background: var(--bg-panel); color: var(--text-sub); border-radius: 8px; cursor: pointer; font-weight: 600; }
      .nav-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
      
      /* Content */
      .content-area { flex: 1; position: relative; overflow: hidden; background-color: var(--bg-panel); border-radius: 16px; border: 1px solid var(--border); }
      .tab-page { display: none; height: 100%; overflow-y: auto; padding: 30px; }
      .tab-page.active { display: block; }
      
      /* Inputs */
      label { font-size: 11px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin-bottom: 5px; display: block; }
      input, select { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--border); background-color: var(--input-bg); color: var(--text-main); margin-bottom: 10px; box-sizing: border-box;}
      
      .btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
      .btn-sm { width: auto; padding: 8px 20px; font-size: 13px; }
      
      /* Loader */
      .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 999; display: none; flex-direction: column; color: white; }
      .spin { width: 30px; height: 30px; border: 3px solid #fff; border-top-color: var(--accent); border-radius: 50%; animation: r 1s infinite linear; margin-bottom: 10px; }
      @keyframes r { to { transform: rotate(360deg); } }

      /* Table & Utils */
      table { width: 100%; border-collapse: collapse; font-size: 13px; }
      th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; }
      .search-box { position: relative; }
      .results-list { position: absolute; top: 100%; left: 0; width: 100%; background: var(--bg-panel); border: 2px solid var(--accent); border-radius: 10px; z-index: 100; display: none; }
      .res-item { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--border); }
      .res-item:hover { background: var(--input-bg); }
      
      @media (max-width: 768px) {
        body { padding: 10px; height: auto; overflow: visible; }
        .app-wrapper { height: auto; min-height: 100vh; }
        .content-area { overflow: visible; height: auto; }
        .tab-page { padding: 15px; height: auto; }
      }
    </style>
  </head>
  <body>
    <div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
    <div class="loader" id="loader"><div class="spin"></div><div id="loaderTxt">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>

    <div class="app-wrapper">
      <div class="header">
        <h1 class="title">CRM <span style="color:var(--accent)">System</span></h1>
        <button onclick="toggleTheme()" style="background:none;border:none;font-size:20px;cursor:pointer;">üåó</button>
      </div>
      <div class="nav">
        <button class="nav-btn active" onclick="tab('Entry')">‚ûï –í–≤–æ–¥</button>
        <button class="nav-btn" onclick="tab('Unshipped')">üì¶ –û—Ç–≥—Ä—É–∑–∫–∞</button>
        <button class="nav-btn" onclick="tab('Ref')">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</button>
      </div>
  
      <div class="content-area">
        <div id="Entry" class="tab-page active">
           <div style="max-width: 500px; margin: 0 auto;">
             <h3>–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h3>
             <form id="formEntry">
               <label>–ì–æ—Ä–æ–¥</label><select id="entryCity" required></select>
               <label>–¢–æ–≤–∞—Ä</label>
               <div class="search-box">
                  <input type="text" id="searchInp" placeholder="–ü–æ–∏—Å–∫..." autocomplete="off" required>
                  <div class="results-list" id="resList"></div>
               </div>
               <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label><input type="number" id="qty" value="1" min="1" required>
               <div style="margin-bottom:20px; font-weight:bold; color:var(--accent); text-align:right;">–ò—Ç–æ–≥–æ: <span id="totalPreview">0</span> ‚ÇΩ</div>
               <button type="submit" class="btn" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
             </form>
           </div>
        </div>
        
        <div id="Unshipped" class="tab-page">
           <div style="margin-bottom:20px; display:flex; gap:10px;">
             <select id="shipCity" onchange="loadUnshippedTable()"></select>
             <button class="btn btn-sm" onclick="loadUnshippedTable()">–û–±–Ω–æ–≤–∏—Ç—å</button>
           </div>
           <div id="unshippedContent"></div>
        </div>
        
        <div id="Ref" class="tab-page">
           <div style="margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:20px;">
               <h4>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h4>
               <form id="formRef" style="display:flex; gap:10px; flex-wrap:wrap;">
                 <input id="newPName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required style="flex:2">
                 <input type="number" id="newPPrice" placeholder="–¶–µ–Ω–∞" required style="flex:1">
                 <input id="newPCat" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è" list="catList" required style="flex:1">
                 <datalist id="catList"></datalist>
                 <button type="submit" class="btn btn-sm">–î–æ–±–∞–≤–∏—Ç—å</button>
               </form>
           </div>
           <input type="text" id="filterRef" placeholder="üîç –§–∏–ª—å—Ç—Ä..." onkeyup="filterRef()">
           <div style="overflow-x:auto"><table id="refTable"><thead><tr><th>–¢–æ–≤–∞—Ä</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–¶–µ–Ω–∞</th></tr></thead><tbody></tbody></table></div>
        </div>
      </div>
    </div>

    <script>
      // ============================================
      // üëá –í–°–¢–ê–í–¨–¢–ï –°–°–´–õ–ö–£ –ù–ê WEB APP –ò–ó –®–ê–ì–ê 1
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbxHieJcrWsBuxL2LQHzRXqdOqno7Y5_VI9VqI-2WE1-oG_dS_zZb6ERkcOGPzBAjn75/exec';
      // ============================================

      let CONFIG = {}, PRODUCTS = [];

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (Sheet vs Web)
      const IS_GAS = typeof google !== 'undefined' && google.script && google.script.run;

      window.onload = () => { 
          if(window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.expand();
          loadConfig();
          document.getElementById('formEntry').onsubmit=saveEntry;
          document.getElementById('formRef').onsubmit=addRef;
          document.getElementById('searchInp').oninput=smartSearch;
          document.getElementById('qty').oninput=calcTotal;
      };

      // --- –ì–õ–ê–í–ù–´–ô –ú–û–°–¢ (BRIDGE) ---
      // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ—à–∞–µ—Ç, –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å: —á–µ—Ä–µ–∑ google.script.run –∏–ª–∏ fetch
      async function runBackend(funcName, payload = {}) {
        document.getElementById('loader').style.display='flex';
        
        if (IS_GAS) {
            // –†–µ–∂–∏–º –≤–Ω—É—Ç—Ä–∏ –¢–∞–±–ª–∏—Ü—ã
            return new Promise((resolve, reject) => {
                const handler = google.script.run
                   .withSuccessHandler((res) => { document.getElementById('loader').style.display='none'; resolve(res); })
                   .withFailureHandler((err) => { document.getElementById('loader').style.display='none'; reject(err); });

                // –ú–∞–ø–ø–∏–Ω–≥ —Ñ—É–Ω–∫—Ü–∏–π, —Ç–∞–∫ –∫–∞–∫ google.script.run –≤—ã–∑—ã–≤–∞–µ—Ç –ø–æ –∏–º–µ–Ω–∏
                if (funcName === 'getInitialConfig') handler.getInitialConfig();
                else if (funcName === 'saveNewEntry') handler.saveNewEntry(payload);
                else if (funcName === 'getUnshippedForCity') handler.getUnshippedForCity(payload.city);
                else if (funcName === 'shipAndGeneratePdf') handler.shipAndGeneratePdf(payload.city, payload.items);
                else if (funcName === 'addNewProduct') handler.addNewProduct(payload.name, payload.price, payload.cat);
                else { reject("–§—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –º–∞–ø–ø–∏–Ω–≥–µ GAS"); }
            });
        } else {
            // –†–µ–∂–∏–º Web (GitHub/Telegram)
            const target = new URL(GAS_URL);
            target.searchParams.append('action', funcName);
            if(payload.city) target.searchParams.append('city', payload.city); // GET –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            target.searchParams.append('data', JSON.stringify(payload));

            const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(target.toString());
            
            try {
                const res = await fetch(proxyUrl);
                if(!res.ok) throw new Error("Network: " + res.status);
                const json = await res.json();
                document.getElementById('loader').style.display='none';
                return json;
            } catch(e) {
                document.getElementById('loader').style.display='none';
                throw e;
            }
        }
      }

      // --- –õ–û–ì–ò–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

      function showToast(m, err=false){
          const x=document.getElementById("toast");
          x.innerText=m;
          x.style.backgroundColor = err ? 'var(--danger)' : 'var(--success)';
          x.className="toast show";
          setTimeout(()=>x.className=x.className.replace("show",""),3000);
      }

      function loadConfig(){
        runBackend('getInitialConfig').then(c => {
          CONFIG=c; PRODUCTS=c.products;
          fillSel('entryCity', c.cities);
          fillSel('shipCity', c.cities, '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥...');
          fillRefTable(c.directoryData);
          const dl=document.getElementById('catList');dl.innerHTML='';
          c.categories.forEach(x=>{const o=document.createElement('option');o.value=x;dl.appendChild(o)});
        }).catch(e => showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: "+e, true));
      }

      function fillSel(id, arr, ph){
          const s=document.getElementById(id); s.innerHTML='';
          if(ph) s.add(new Option(ph, ''));
          arr.forEach(x=>s.add(new Option(x,x)));
      }

      function smartSearch(e){
          const v=e.target.value.toLowerCase(), l=document.getElementById('resList'); l.innerHTML='';
          if(!v){l.style.display='none';return;}
          const m=PRODUCTS.filter(p=>p.name.toLowerCase().includes(v)).slice(0,8);
          if(m.length){
              l.style.display='block';
              m.forEach(p=>{
                  const d=document.createElement('div'); d.className='res-item';
                  d.innerHTML=`<b>${p.name}</b> <small>(${p.price}—Ä)</small>`;
                  d.onclick=()=>{
                      document.getElementById('searchInp').value=p.name;
                      l.style.display='none'; calcTotal();
                  };
                  l.appendChild(d);
              });
          } else l.style.display='none';
      }

      function calcTotal(){
          const n=document.getElementById('searchInp').value, q=document.getElementById('qty').value;
          const p=PRODUCTS.find(x=>x.name.toLowerCase()===n.toLowerCase());
          const price = p ? p.price : 0;
          document.getElementById('totalPreview').innerText = (price * q);
      }

      function saveEntry(e){
          e.preventDefault();
          const p = {
              city: document.getElementById('entryCity').value,
              productName: document.getElementById('searchInp').value,
              quantity: document.getElementById('qty').value
          };
          runBackend('saveNewEntry', p).then(r => {
              showToast(r.message, !r.success);
              if(r.success) { 
                  document.getElementById('searchInp').value=''; 
                  document.getElementById('qty').value=1; 
                  calcTotal(); 
              }
          }).catch(e => showToast(e, true));
      }

      function loadUnshippedTable(){
          const c=document.getElementById('shipCity').value;
          const d=document.getElementById('unshippedContent');
          if(!c) return;
          d.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
          runBackend('getUnshippedForCity', {city:c}).then(arr => {
              if(!arr.length) { d.innerHTML="–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤"; return; }
              let h = `<button class="btn" style="margin-bottom:15px;background:var(--success)" onclick='doShip("${c}")'>üìÑ –°–∫–∞—á–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—É—é (PDF)</button>`;
              h += `<table><tr><th>‚úì</th><th>–¢–æ–≤–∞—Ä</th><th>–ö–æ–ª</th><th>–°—É–º–º–∞</th></tr>`;
              arr.forEach((x,i) => {
                  h+=`<tr><td><input type="checkbox" class="ship-chk" checked data-idx="${i}"></td><td>${x.name}</td><td>${x.qty}</td><td>${x.total}</td></tr>`;
              });
              h+=`</table>`;
              d.innerHTML=h;
              d.dataset.items = JSON.stringify(arr);
          });
      }

      function doShip(city){
          const d=document.getElementById('unshippedContent');
          const all = JSON.parse(d.dataset.items);
          const chks = document.querySelectorAll('.ship-chk:checked');
          if(!chks.length) return showToast("–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ", true);
          
          const sel = [];
          chks.forEach(c => sel.push(all[c.dataset.idx]));

          runBackend('shipAndGeneratePdf', {city: city, items: sel}).then(r => {
              if(r.success){
                  const blob = base64ToBlob(r.pdfData);
                  const url = window.URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url; a.download = `Invoice_${city}.pdf`;
                  a.click();
                  loadUnshippedTable(); // Refresh
              } else showToast(r.message, true);
          }).catch(e => showToast(e, true));
      }

      function addRef(e){
          e.preventDefault();
          runBackend('addNewProduct', {
              name: document.getElementById('newPName').value,
              price: document.getElementById('newPPrice').value,
              cat: document.getElementById('newPCat').value
          }).then(r => {
              showToast(r.message, !r.success);
              if(r.success) loadConfig();
          });
      }

      function base64ToBlob(base64) {
        const bin = atob(base64);
        const len = bin.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = bin.charCodeAt(i);
        return new Blob([bytes], { type: 'application/pdf' });
      }

      function fillRefTable(d){
          const t=document.querySelector('#refTable tbody');t.innerHTML='';
          d.forEach(x=>{const r=document.createElement('tr');r.innerHTML=`<td>${x.name}</td><td>${x.category}</td><td>${x.price}</td>`;t.appendChild(r)});
      }

      function tab(id){
          document.querySelectorAll('.tab-page').forEach(x=>x.classList.remove('active'));
          document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
          document.getElementById(id).classList.add('active');
          event.target.classList.add('active');
      }
      function toggleTheme(){
          const b=document.body;
          b.setAttribute('data-theme', b.getAttribute('data-theme')==='dark'?'light':'dark');
      }
    </script>
  </body>
</html>
